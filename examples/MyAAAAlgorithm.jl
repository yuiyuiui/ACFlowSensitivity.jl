using ACFlowSensitivity
using Plots


#μ=3*rand(2).-1.5;σ=rand(2);peak=4*rand(2);
μ=[0.5,-2.5];σ=[0.2,0.8];peak=[1.0,0.3];
A=continous_spectral_density(μ,σ,peak);
β=10.0;
N=20;
output_bound=5.0;
output_number=801;
noise=1e-2;
Amesh,reconstruct_A,_=aaa_check(A;β,N,output_bound,output_number,noise);

# draw the pictures
plot(Amesh,reconstruct_A.(Amesh),label="reconstruct SD, noise: $noise")
plot!(Amesh,A.(Amesh),label="origin SD")



#------------
#example with a pole 

DA=kernel(0.001)

DAmesh,reconstruct_DA,bary_func=aaa_check(DA;N=20,output_number=801)

plot(DAmesh,reconstruct_DA,label="reconstruct spectral density")
plot!(DAmesh,DA.(DAmesh),label="origin spectral density")

points_to_poles=rand(ComplexF64,5).*[1e-1,1e-2,1e-3,1e-4,1e-5]
res=points_to_poles.*bary_func.(points_to_poles)




#-------------------------
#example with poles
N=10
γ=rand(N)*2;

reγ=DireInverse_check(β,N,γ);



println(γ)
println(reγ)



#------------------


test1=[0.05116179114033364 - 0.044870091384331894im 0.008428511628484726 + 0.0016506903360650844im 0.046113407192331514 - 0.00012177845942261109im 0.026737735751661097 + 0.00831227715574161im 0.017233582497163166 + 0.004740749877580775im 0.0309305575827947 + 0.009060236801388956im; 0.09637728259238951 - 0.12160024172071356im 0.017144401389585107 + 0.004857910838735632im 0.09128490582839471 - 0.011650995598243886im 0.052475960858802295 + 0.017442484576927413im 0.03426404703526267 + 0.011682415208118729im 0.060667839814289644 + 0.0173909206857882im; 0.0648627804255138 - 0.06238309308233602im 0.01095629111728647 + 0.0024706768106222622im 0.059165141826828825 - 0.0014867551572634314im 0.034311258691988464 + 0.01118177079606285im 0.022232931685263097 + 0.00667419866744922im 0.039653801071147944 + 0.011945023559493716im; 0.08797350330891456 - 0.1023681605732056im 0.015443865871378476 + 0.0041773762159767495im 0.08232922612500637 - 0.007538441946562868im 0.047500916441889744 + 0.015969765155232348im 0.03097726646246067 + 0.010340504104395236im 0.0548885867627334 + 0.016299272092301708im; 0.04857809010504715 - 0.04193703633693911im 0.007963823979396377 + 0.0015146573234358833im 0.043694018351226056 + 2.3592729469075433e-5im 0.025328138987001817 + 0.007791153173925865im 0.016307206506986492 + 0.004405504814627264im 0.029306866582252785 + 0.0085216639223554im; 0.04410952270965285 - 0.03709678492188182im 0.007169504845192362 + 0.0012935191731544878im 0.03953719072714045 + 0.00021202021995231143im 0.022904259638358473 + 0.006910306491733112im 0.01471796191488887 + 0.003849449131417127im 0.026514082177485528 + 0.007602138919184888im; 0.10638453513018035 - 0.14914533924271933im 0.019229874140574418 + 0.005662720485205603im 0.10252087730963455 - 0.018595055970133664im 0.05861090181416918 + 0.01875972326453963im 0.038289704657986916 + 0.013163358768517552im 0.06783124976971677 + 0.018023758084024705im; 0.060812771122791404 - 0.0568273380362275im 0.01019823716363523 + 0.0022113495734302647im 0.055264917005557586 - 0.0009619621910607335im 0.03205518495459555 + 0.010319795380425774im 0.020740365962158613 + 0.006077140868328478im 0.03705478637355875 + 0.01109401732743511im; 0.07474630712713153 - 0.07755922645858832im 0.012842414947475988 + 0.0031584428706576714im 0.06885969971647751 - 0.003335820724279117im 0.03988099806149022 + 0.013290676270168264im 0.025924974519321173 + 0.008203581780749043im 0.04607609800545257 + 0.013956862375725184im; 0.06946810050605944 - 0.06914856344761736im 0.011828878728705462 + 0.0027818916728283693im 0.06364909318313676 - 0.002237684682567949im 0.036894871870643636 + 0.01216679750032712im 0.023944607717865957 + 0.007375492715935221im 0.04263154699273232 + 0.01289836827221036im; 0.05402840770383614 - 0.048249406278547076im 0.008948641153047518 + 0.0018086156957881742im 0.048812195495487876 - 0.0003188627358920838im 0.02830859340169734 + 0.008899473157847717im 0.018267653038140576 + 0.005124155334730814im 0.032739775612930705 + 0.009662047680180632im; 0.046238126049331425 - 0.039367168374694686im 0.00754638539015465 + 0.0013966264745457699im 0.041513061026641915 + 0.00013153812270326514im 0.02405664376937705 + 0.007326504392948192im 0.01547292813486353 + 0.0041105286153593585im 0.027841997623369003 + 0.00803802500084545im; 0.05722576085661183 - 0.05218530209409179im 0.009534337080498282 + 0.001993386300412531im 0.05184131039363252 - 0.0005885379075109503im 0.030069235255469035 + 0.009564165806104762im 0.019428620302218272 + 0.005565538536970115im 0.03476747150244856 + 0.010336528515845263im; 0.1439755175001217 - 0.38948991941723304im 0.030187639918747067 + 0.00661948408316164im 0.16611186858787988 - 0.10763336650140409im 0.09268036941824458 + 0.00724670967816492im 0.0598067924374365 + 0.012123869821070351im 0.10830914111122479 - 0.0027943735471799465im]

test2=[0.05116179114033364 - 0.044870091384331894im 0.008428511628484726 + 0.0016506903360650844im 0.046113407192331514 - 0.00012177845942261109im 0.026737735751661097 + 0.00831227715574161im 0.017233582497163166 + 0.004740749877580775im 0.0309305575827947 + 0.009060236801388956im; 0.09637728259238951 - 0.12160024172071356im 0.017144401389585107 + 0.004857910838735632im 0.09128490582839471 - 0.011650995598243886im 0.052475960858802295 + 0.017442484576927413im 0.03426404703526267 + 0.011682415208118729im 0.060667839814289644 + 0.0173909206857882im; 0.0648627804255138 - 0.06238309308233602im 0.01095629111728647 + 0.0024706768106222622im 0.059165141826828825 - 0.0014867551572634314im 0.034311258691988464 + 0.01118177079606285im 0.022232931685263097 + 0.00667419866744922im 0.039653801071147944 + 0.011945023559493716im; 0.08797350330891456 - 0.1023681605732056im 0.015443865871378476 + 0.0041773762159767495im 0.08232922612500637 - 0.007538441946562868im 0.047500916441889744 + 0.015969765155232348im 0.03097726646246067 + 0.010340504104395236im 0.0548885867627334 + 0.016299272092301708im; 0.04857809010504715 - 0.04193703633693911im 0.007963823979396377 + 0.0015146573234358833im 0.043694018351226056 + 2.3592729469075433e-5im 0.025328138987001817 + 0.007791153173925865im 0.016307206506986492 + 0.004405504814627264im 0.029306866582252785 + 0.0085216639223554im; 0.04410952270965285 - 0.03709678492188182im 0.007169504845192362 + 0.0012935191731544878im 0.03953719072714045 + 0.00021202021995231143im 0.022904259638358473 + 0.006910306491733112im 0.01471796191488887 + 0.003849449131417127im 0.026514082177485528 + 0.007602138919184888im; 0.10638453513018035 - 0.14914533924271933im 0.019229874140574418 + 0.005662720485205603im 0.10252087730963455 - 0.018595055970133664im 0.05861090181416918 + 0.01875972326453963im 0.038289704657986916 + 0.013163358768517552im 0.06783124976971677 + 0.018023758084024705im; 0.060812771122791404 - 0.0568273380362275im 0.01019823716363523 + 0.0022113495734302647im 0.055264917005557586 - 0.0009619621910607335im 0.03205518495459555 + 0.010319795380425774im 0.020740365962158613 + 0.006077140868328478im 0.03705478637355875 + 0.01109401732743511im; 0.07474630712713153 - 0.07755922645858832im 0.012842414947475988 + 0.0031584428706576714im 0.06885969971647751 - 0.003335820724279117im 0.03988099806149022 + 0.013290676270168264im 0.025924974519321173 + 0.008203581780749043im 0.04607609800545257 + 0.013956862375725184im; 0.06946810050605944 - 0.06914856344761736im 0.011828878728705462 + 0.0027818916728283693im 0.06364909318313676 - 0.002237684682567949im 0.036894871870643636 + 0.01216679750032712im 0.023944607717865957 + 0.007375492715935221im 0.04263154699273232 + 0.01289836827221036im; 0.05402840770383614 - 0.048249406278547076im 0.008948641153047518 + 0.0018086156957881742im 0.048812195495487876 - 0.0003188627358920838im 0.02830859340169734 + 0.008899473157847717im 0.018267653038140576 + 0.005124155334730814im 0.032739775612930705 + 0.009662047680180632im; 0.046238126049331425 - 0.039367168374694686im 0.00754638539015465 + 0.0013966264745457699im 0.041513061026641915 + 0.00013153812270326514im 0.02405664376937705 + 0.007326504392948192im 0.01547292813486353 + 0.0041105286153593585im 0.027841997623369003 + 0.00803802500084545im; 0.05722576085661183 - 0.05218530209409179im 0.009534337080498282 + 0.001993386300412531im 0.05184131039363252 - 0.0005885379075109503im 0.030069235255469035 + 0.009564165806104762im 0.019428620302218272 + 0.005565538536970115im 0.03476747150244856 + 0.010336528515845263im; 0.1439755175001217 - 0.38948991941723304im 0.030187639918747067 + 0.00661948408316164im 0.16611186858787988 - 0.10763336650140409im 0.09268036941824458 + 0.00724670967816492im 0.0598067924374365 + 0.012123869821070351im 0.10830914111122479 - 0.0027943735471799465im]

norm(test1-test2)

svd(test1)

eigen(test2'*test2)